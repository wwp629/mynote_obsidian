---
tags:
  - 蓝牙/通信
  - 项目/止鼾器
  - 硬件/固件
  - 软件/APP
aliases:
  - 蓝牙Notify模式优化
  - FFE1数据通信优化
  - 止鼾器蓝牙通信
---

# 止鼾器项目：蓝牙通信数据通知模式优化

## 1. 背景与优化目标

### 1.1 背景
无论是安卓还是iOS端，通过主动读取 `FFE1` 数据的方式（即手机端发送指令，蓝牙外设响应发送数据，手机端接收，完成 `a-b-a` 的完整过程），会造成通信压力过大。这导致蓝牙频繁断开重连，若有一次重连失败，则可能导致治疗失败。此问题在性能较差的手机（如安卓低端机）上尤为明显，严重影响用户体验。

### 1.2 优化目标
将 `FFE1` 数据通信方式改为 `notify` 模式。在此模式下，蓝牙外设只需定期将数据发送给手机（完成 `b-a` 的过程），这将极大降低蓝牙断开的概率。该方案已在安卓端连续高强度测试1周并完成验证，效果显著。

## 2. FFE1 数据获取优化

### 2.1 Notify 机制
-   **FFE1数据获取**：蓝牙外设每2.5秒发送一次 `FFE1` 数据。
-   **APP修改**：APP 修改 `FFE1` 数据获取方式为监听 `FFE1` 数据通知。

### 2.2 时间戳与数据校验
-   **数据新鲜度**：对收到的 `FFE1` 通知数据添加时间戳，以保证数据校验新鲜。
> [!TIP] 时间戳初始化
    > 在开始校验前，初始化时间戳为启动 `checkFFE1` 的时间，避免第一次校验时出现异常的时间差值。
-   **数据过期判断**：原有的 `FFE1` 校验逻辑中，如果当前时间与收到 `FFE1` 数据时间戳差值 > 4秒，则认为数据过期，忽略本次校验。
-   **Notify 异常纠正**：如果当前时间与收到 `FFE1` 数据时间戳差值 > 7.5秒，认为蓝牙外设数据 `notify` 功能异常，主动向蓝牙主机写入当前治疗状态（`0x87` 或 `0xB9`）+ 档位（本地存储的档位）以纠正蓝牙外设 `notify` 功能。此操作允许写入3次。
> [!WARNING] 注意事项
    > 写入档位后，需立即初始化 `FFE1` 时间戳，否则即使写入指令，数据仍可能因旧的时间戳而继续过期。

### 2.3 校验时间与日志
-   **FFE1校验时间**：修改为与 `notify` 时间（2.5秒）一致。
-   **日志记录**：对应修改间隔次数，以保持与之前逻辑差不多的间隔时间保存一次 `FFE1` 到日志。

### 2.4 电池电量获取
-   **获取方式变更**：电池电量获取从 UUID `00002a19-0000-1000-8000-00805f9b34fb` 读取，改为经过 `FFE1` 解析字节6（电池电量 `Soc`）来获取。
> [!NOTE] 目的
    > 减轻蓝牙通信压力。

### 2.5 蓝牙状态与校验
-   **断开时停止**：蓝牙状态断开时，停止 `FFE1` 校验。
-   **重连后重启**：重连成功后重启 `FFE1` 校验。
> [!NOTE] 目的
    > 减轻蓝牙通信压力。

## 3. UUID 特征值读取策略

### 3.1 读取时机
-   仅在进入20分钟治疗前读取 UUID 特征值。

### 3.2 UUID 过滤
-   只读取以下特定 UUIDs：`00002a23-0000-1000-8000-00805f9b34fb`、`00002a25-0000-1000-8000-00805f9b34fb`、`00002a28-0000-1000-8000-00805f9b34fb`。
-   其他所有已知或未知的无用 UUID（吴工提供的《电子止鼾器协议说明》中可能遗漏的无用 UUID）都应过滤掉读的操作。
> [!NOTE] 目的
    > 减轻蓝牙通信压力。

### 3.3 治疗后停止
-   进入20分钟治疗后，停止 UUID 特征值读取。
> [!TIP] 参考说明
    > （此处仅供参考，安卓之前版本在进入治疗后，仍在读取各种 UUID，但这些信息只在治疗前的检验用到，进入治疗后都使用不到，停止读取可减轻蓝牙通信压力。）

## 4. 蓝牙断开重连优化

### 4.1 重连超时时间
-   蓝牙断开重连超时时间修改为15秒。
> [!NOTE] 理由
    > 由于安卓端测试发现，大部分重连时间为2~4秒，但也有极端情况需要8~9秒才能重连回来，因此将安卓端蓝牙断开重连超时时间修改为15秒更为安全。

### 4.2 快速重连 (参考)
-   增加快速重连机制。
> [!TIP] 方案
    > （仅供参考，安卓端之前的断开重连策略是重新扫描开始进行重连。现在修改为：当开始治疗时使用正常的扫描连接，同时保存已连接设备的MAC地址；在治疗过程中遇到断开重连时，使用MAC地址进行直接重连，跳过扫描步骤，以节省重连时间。）

## 5. 指令写入失败补救措施 (参考)

### 5.1 启动治疗指令 (0x87) 写入失败
-   **问题**：目前安卓端，写入指令后回调可能是 `false`，但实际可能已写入成功。若不作处理，可能导致启动失败，尤其在启动治疗阶段写入 `0x87` 时，若仅以回调作为判断依据，可能导致启动失败。
-   **补救措施**：若写入指令回调 `false`，则延迟400毫秒，检查一次蓝牙外设中 `FFE1` 的字节2状态信息，以确认是否真的写入失败。
> [!NOTE] 延迟值说明
    > 延迟400毫秒是因为 `FFE1` 已改为每2.5秒 `notify` 一次。安卓端目前底层定义的写入指令方法若回调失败会重写3次，这3次过程中都可能收到 `FFE1` 字节2状态已经更新。此延迟值仅为安卓端测试比较合适的时间，供参考。

### 5.2 治疗中档位/暂停指令 (0xB9) 写入失败
-   **问题**：安卓端测试发现治疗过程中也存在档位或暂停写入回调失败的情况。
-   **补救措施**：同 **5.1 启动治疗指令 (0x87) 写入失败** 中的措施。

### 5.3 治疗中/结束指令 (0x00) 写入失败
-   **问题**：安卓端测试发现治疗过程中或治疗结束后，写入指令 `0x00` 回调失败的情况。
-   **补救措施**：直接断开蓝牙，释放蓝牙资源，并完成其他清理动作。

## 6. 线程管理优化 (参考)

-   **问题**：安卓之前邬工编写的蓝牙底层操作全部放在主线程中，可能导致线程阻塞，影响蓝牙连接及重连。
-   **优化建议**：
    *   将蓝牙 `connect` 操作放到主线程中。
    *   将蓝牙数据读取、`notify` 数据获取、扫描、停止等其他蓝牙操作放到蓝牙工作线程中处理。
    *   各种操作结果的回调需要返回到主线程中。

## 7. 软件版本号解析注意事项 (参考)

-   **版本号更新**：嵌入式软件版本号已迭代至 `1.0.0.101`，测试时请注意使用此版本。
-   **解析问题**：邬工之前编写的版本号解析为固定位数解析，会导致 `1.0.0.101` 解析后被截断为 `1.0.0.10`。请修正解析逻辑以支持新版本号。