---
创建时间: Invalid date
上次编辑者: wwang.wenping
上次编辑时间: Invalid date
---
目的：不管是安卓还是iOS端，通过主动读取FFE1数据的方式，因为手机端读发送指令，需要蓝牙外设响应发送数据，然后手机端接收，需要完成a-b-a的完整过程，造成通信压力过大，会导致频繁的蓝牙断开重连，如果有一次重连失败，就会治疗失败，特别是在一些性能较差的手机上（比如安卓低端机）表现的非常明显，对使用体验有非常大的影响。

  

修改措施：将FFE1数据通信方式，改为notify模式，这样蓝牙外设将数据定期发送给手机即可，只需要完成b-a的过程，将极大的降低蓝牙断开的概率。已经在安卓端连续高强度测试1周，完成验证，效果非常明显。

  

具体修改：

### 1.FFE1数据获取

- notify获取，蓝牙外设每2.5s发送一次FFE1数据；
- APP**修改FFE1数据获取方式为，监听FFE1数据通知**；
- 对**收到通知FFE1数据，添加时间戳，保证FFE1数据校验新鲜**（_在开始校验前初始化时间戳为启动checkFFE1的时间，避免第一次校验时出现异常的时间差值_）；
    - 原有的FFE1校验逻辑中，添加当前时间与收到FFE1数据时间戳差值如果＞4s，认为数据过期，忽略本次校验；
    - 当前时间与收到FFE1数据时间戳差值如果＞7.5s，认为蓝牙外设数据notify已经异常，主动向蓝牙主机写入当前治疗状态（0x87或0xB9）+档位（本地存储的档位）以纠正蓝牙外设notify功能，这里允许写入3次；
        - 写入档位后，要初始化一下FFE1时间戳，否则会以最后一次正常数据的时间戳为准，导致即使写入指令，数据也会继续过期。
- **FFE1校验时间，修改为与notify时间一致，对应的间隔次数保存一次FFE1到日志也要进行修改**（修改间隔次数，以保持与之前逻辑差不多的间隔时间保存一次FFE1到日志）。
- **电池电量获取，从UUID：00002a19-0000-1000-8000-00805f9b34fb读取，改为经过FFE1解析字节6 电池电量Soc来获取，减轻蓝牙通信压力**。
- **蓝牙状态断开时，停止FFE1校验，重连成功后重启FFE1校验，减轻蓝牙通信压力**。

  

### 2.UUID特征值读取

- 在进入20分钟治疗前读取UUID特征值；
- UUID只读取00002a23-0000-1000-8000-00805f9b34fb、00002a25-0000-1000-8000-00805f9b34fb、00002a28-0000-1000-8000-00805f9b34fb，**其他所有已知的、未知的**（吴工提供的《电子止鼾器协议说明》中有遗漏的无用uuid没有说明）**UUID都要过滤掉读的操作，减轻蓝牙通信压力**。
- **进入20分钟治疗后，停止UUID特征值读取，减轻蓝牙通信压**力；（此处仅供参考，安卓之前版本在进入治疗后，也在读取各种UUID，这些信息只是在治疗前的检验用到，进入治疗后这些信息都使用不到）

  

### 3.蓝牙断开重连

- **蓝牙断开重连，超时时间修改为15s**。（由于安卓端测试发现，当断开后大部分重连时间为2~4s时间，但是也有一些极端情况需要8~9s才可能重连回来，所以现在安卓端蓝牙断开重连超时时间修改为15s比较安全一点）
- 增加快速重连（仅供参考，安卓端之前的断开重连策略是重新扫描开始进行重连，现在修改为当开始治疗时使用正常的扫描连接，同时保存连上设备的MAC地址，再治疗过程中遇到断开重连时使用MAC进行直接重连，跳过扫描，节省重连时间）。

  

### 4.启动治疗写入指令0x87启动，回调false，补救措施（仅供参考）

- 目前安卓端，写入指令后，回调可能是false，但是实际可能是写入成功了，如果不做处理，会导致写入失败，特别是在**启动治疗阶段，写入0x87，如果仅以回调作为判读**，可能导致启动失败。
- 补救措施，写入指令回调false的话，延迟400ms，检查一次蓝牙外设中FFE1的字节2状态信息，以确认是否是真的入失败了。（注意延迟400ms，是因为现在FFE1改为2.5s notify一次，而安卓端目前底层定义的写入指令方法如果回调失败会重新写，总共3次，这3次过程中，都可能会收到FFE1字节2状态已经更新。且这个延迟值，仅为在安卓端测试比较合适的时间，供参考）

  

### 5.治疗过程中，写入指令档位或暂停0xB9，回调false，补救措施（仅供参考）

- 安卓端测试发现治疗过程中也会存在档位或者暂停写入回调失败的情况。
- 治疗过程中，档位或暂停写入指令失败，**同4中措施**。

  

### 6.治疗过程中或治疗正常结束，写入指令0x00启动，回调false，补救措施（仅供参考）

- 安卓端测试发现治疗过程中或治疗结束后，写入指令0x00回调失败的情况。
- 补救措施，**直接断开蓝牙，释放蓝牙资源，并完成其他清理动作**。

  

### 7.线程管理（仅供参考）

- 安卓之前邬工写的蓝牙底层操作，全部放在主线程中操作，可能导致线程阻塞，影响蓝牙连接以及重连，优化蓝牙操作的线程管理。
- 将蓝牙connect操作放到主线程中。
- 将蓝牙数据读取、notify数据获取、扫描、停止等其他蓝牙操作放到蓝牙工作线程中处理，但是各种操作结果的回调需要返回到主线程中。

  

### 8.软件版本号解析（仅供参考）

- 嵌入式软件版本号已经迭代到了1.0.0.101，注意以这个版本进行测试。
- 邬工之前写的版本号解析，为固定位数解析，会导致1.0.0.101解析后被截断为1.0.0.10。