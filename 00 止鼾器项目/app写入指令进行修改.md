---
tags:
  - 项目/止鼾器
  - 蓝牙/通信
  - 硬件/固件
  - 软件/APP
  - 性能优化
aliases:
  - APP写入指令修改
  - 蓝牙通信优化
  - FFE1到FFE3切换
---

# APP写入指令及蓝牙通信优化

## 1. 概述与背景

*   **背景**: 根据压力测试，现有架构中，嵌入式端对 `FFE1` 进行加密传输以及APP端对嵌入式进行加密写入操作，导致嵌入式资源消耗过大，偶发蓝牙断开等异常。
*   **修改目标**: 优化蓝牙通信方式，降低嵌入式端资源消耗。
*   **核心调整**:
    *   **启动时**: 对 `FFE1` 进行写操作，启动硬件（加密）。
    *   **启动后 (治疗过程中)**: 所有操作均对 `FFE3` 进行（包括之前的对收到的 `FFE1` 校验，也修改为对 `FFE3` 进行校验）。

## 2. 电池电量获取策略修改

*   **治疗前检查**:
    *   电池电量数据获取方式修改为主动读取 UUID `00002a19-0000-1000-8000-00805f9b34fb`。
> [!NOTE] 目的
    >   同其他治疗前检查设备信息获取数据一样，主动读取仅在治疗前检查时使用。读取到数据后即停止读取（后续整个治疗过程中都不允许再读取这些值，以降低设备运行负担）。
*   **治疗过程中**:
    *   电池电量数据获取修改为解析 `FFE3 notify` 的数据。

## 3. 写入操作机制修改

*   **开始治疗时**:
    *   仅在首页点击“开始治疗”时，使用现有写入指令操作方式不变（此时仍然是同样的加密方式向 `FFE1` 写入指令）。
*   **治疗过程中及结束**:
    *   所有写操作改为**明文写入**到 `FFE3`。
    *   > [!NOTE] 目的
    >   主要目的是降低硬件加解密的压力。

## 4. 治疗过程中通信数据获取修改

*   **取消 `FFE1` Notify**:
    *   取消 `FFE1` 的 `notify` 数据获取。硬件被启动治疗后，不会再通过 `FFE1` `notify` 加密的通信数据。
*   **启用 `FFE3` Notify**:
    *   开启 `FFE3` `notify` 功能。治疗开始后，`FFE3` 明文 `notify` 硬件数据。
    *   数据解析不再需要解密。
    *   > [!TIP] `FFE3` 数据格式
    >   `FFE3` 数据格式与 `FFE1` 一模一样，是 `FFE1` 的明文，其解析仅需去掉原来的解密过程即可。

## 5. 治疗过程中数据校验修改

> [!WARNING] 蓝牙重启说明
> 大量测试发现，当通信数据校验失败时，有些情况下直接写入指令一定无法成功。这可能是因为底层蓝牙协议栈已经阻塞，需要先重启一次蓝牙才能写入成功。
> 对于蓝牙重启，已在安卓端测试验证过：流程是 `close() → Scan() → …` 完成连接。注意不能操作 `disconnect()`，因为硬件会认为APP主动断开蓝牙，从而重置治疗状态（即硬件端会绿灯闪烁，完全结束本次治疗）。对应iOS端如何操作，仅供参考。

### 5.1 校验目标切换
*   `FFE1` 数据校验切换为 `FFE3` 数据校验。

### 5.2 数据新鲜度校验 (`FFE3`)
*   **原逻辑**: 多次没有收到新鲜数据，就直接写入一次指令。
*   **修改为**: 2次数据不新鲜，则先重启一次蓝牙连接流程，完成连接后再往 `FFE3` 写入当前状态、档位，以恢复数据不新鲜的问题。

### 5.3 档位校验 (`FFE3`)
*   **原逻辑**: 多次档位不一致，就直接写入一次指令。
*   **修改为**: 2次档位不一致，则先重启一次蓝牙连接流程，完成连接后再往 `FFE3` 写入当前状态、档位，以恢复数据不新鲜的问题。

### 5.4 非工作中校验 (`FFE3`)
*   **背景**: 参考下图异常状态定义（根据 `FFE3` 数据中字节2、字节4(bit7、bit5)）。原逻辑中，检测到非工作中就会直接终止。实际测试发现这是硬件输出异常导致的（原因未知），此时蓝牙并没有问题，所以APP可以补救恢复正常。
*   **补救措施**: 同数据新鲜、档位校验一样，2次非工作中，则往 `FFE3` 写入一次当前本地的档位、状态。
> [!NOTE] 无需重启蓝牙
    > 与前面两种校验不同，此情况下不需要重启蓝牙，直接写入即可。

![[image 13.png|image 13.png]]

*   **其他逻辑**: `FFE3` 通信数据其他逻辑不变。